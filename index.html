<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Particle System</title>
    <style>
        body { margin: 0; overflow: hidden; background: #111; color: white; font-family: sans-serif; }
        
        /* Debug Console to see errors on phone */
        #console-log {
            position: absolute; top: 0; left: 0; width: 100%; height: 40%;
            background: rgba(0,0,0,0.8); color: #00ff00; font-family: monospace;
            font-size: 12px; overflow-y: scroll; z-index: 200; pointer-events: none;
            padding: 10px; border-bottom: 2px solid #00ff00;
        }

        #start-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; z-index: 100; display: flex; 
            flex-direction: column; justify-content: center; align-items: center;
        }

        button {
            padding: 20px 40px; font-size: 18px; background: #0088ff; color: white;
            border: none; border-radius: 8px; margin-top: 20px;
        }

        video {
            position: absolute; bottom: 0; right: 0; width: 100px; height: 100px;
            opacity: 0.5; z-index: 50; transform: scaleX(-1);
        }
    </style>
</head>
<body>

    <div id="console-log">Waiting for user...<br></div>

    <div id="start-overlay">
        <h1>Particle System</h1>
        <p>Tap below to start</p>
        <button onclick="startApp()">START CAMERA</button>
    </div>

    <video id="input-video" playsinline muted autoplay></video>

    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>
    <script type="module">
        import * as THREE from 'https://cdn.skypack.dev/three@0.136.0';
        window.THREE = THREE; // Make available globally
    </script>

    <script>
        // Custom Logger to print to screen
        function log(msg) {
            const c = document.getElementById('console-log');
            c.innerHTML += `> ${msg}<br>`;
            c.scrollTop = c.scrollHeight;
            console.log(msg);
        }

        window.onerror = function(message, source, lineno, colno, error) {
            log(`âŒ ERROR: ${message} at line ${lineno}`);
        };

        async function startApp() {
            log("ðŸš€ Start button clicked.");
            document.getElementById('start-overlay').style.display = 'none';

            // Check if Three.js loaded
            if (!window.THREE) {
                log("âŒ Three.js failed to load. Check internet.");
                return;
            } else {
                log("âœ… Three.js loaded.");
            }

            // 1. Try to access Camera directly first
            log("ðŸ“¸ Requesting Camera Access...");
            
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                log("âŒ Browser API error: navigator.mediaDevices is missing. Are you using HTTPS?");
                return;
            }

            try {
                const stream = await navigator.mediaDevices.getUserMedia({
                    audio: false,
                    video: {
                        facingMode: 'user', // Request front camera explicitly
                        width: { ideal: 640 },
                        height: { ideal: 480 }
                    }
                });
                
                log("âœ… Camera Access GRANTED!");
                const video = document.getElementById('input-video');
                video.srcObject = stream;
                video.onloadedmetadata = () => {
                    video.play();
                    log("âœ… Video stream playing.");
                    initSystem(video);
                };

            } catch (err) {
                log(`âŒ CAMERA FAILED: ${err.name} - ${err.message}`);
                log("ðŸ’¡ TIP: Check Android Settings > Chrome > Permissions");
            }
        }

        function initSystem(videoElement) {
            log("ðŸ§  Initializing MediaPipe Hands...");
            
            try {
                const hands = new Hands({locateFile: (file) => {
                    return `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`;
                }});

                hands.setOptions({
                    maxNumHands: 1,
                    modelComplexity: 0, // 0 is fastest for mobile
                    minDetectionConfidence: 0.5,
                    minTrackingConfidence: 0.5
                });

                hands.onResults(onResults);

                // Start Camera Utils
                const camera = new Camera(videoElement, {
                    onFrame: async () => {
                        await hands.send({image: videoElement});
                    },
                    width: 640,
                    height: 480
                });
                camera.start();
                log("âœ… MediaPipe Started. Making 3D Scene...");
                
                initThreeJS();

            } catch (e) {
                log("âŒ MediaPipe Error: " + e.message);
            }
        }

        // --- Simplified Three.js for testing ---
        let scene, camera, renderer, cube;
        function initThreeJS() {
            try {
                scene = new window.THREE.Scene();
                camera = new window.THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
                renderer = new window.THREE.WebGLRenderer({alpha: true});
                renderer.setSize(window.innerWidth, window.innerHeight);
                document.body.appendChild(renderer.domElement);

                const geometry = new window.THREE.BoxGeometry();
                const material = new window.THREE.MeshBasicMaterial( { color: 0x00ff00, wireframe: true } );
                cube = new window.THREE.Mesh( geometry, material );
                scene.add( cube );
                camera.position.z = 5;

                animate();
                log("âœ… 3D Scene Running! (Look for a spinning cube)");
            } catch (e) {
                log("âŒ 3D Error: " + e.message);
            }
        }

        function onResults(results) {
            if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
                // If we see hands, rotate the cube
                if(cube) {
                    cube.rotation.x += 0.1;
                    cube.rotation.y += 0.1;
                    // log("ðŸ‘‹ Hand Detected!"); // Uncomment if needed, but spams log
                }
            }
        }

        function animate() {
            requestAnimationFrame( animate );
            if(renderer && scene && camera) renderer.render( scene, camera );
        }

    </script>
</body>
</html>
