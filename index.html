<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3D Gesture Particles</title>
    <style>
        body { margin: 0; overflow: hidden; background: #000; font-family: 'Segoe UI', sans-serif; }
        /* The Overlay Button */
        #overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); display: flex; flex-direction: column;
            justify-content: center; align-items: center; z-index: 100; color: white;
        }
        button {
            padding: 15px 30px; font-size: 1.2rem; cursor: pointer;
            background: #00ffcc; border: none; border-radius: 50px; font-weight: bold;
        }
        #video-container {
            position: absolute; bottom: 10px; right: 10px; width: 120px; height: 90px;
            border: 1px solid #444; border-radius: 8px; overflow: hidden; z-index: 10;
        }
        #video-input { width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1); }
        #ui { position: absolute; top: 20px; left: 20px; color: #fff; pointer-events: none; z-index: 50; }
    </style>
</head>
<body>

    <div id="overlay">
        <h2>Interactive 3D Particles</h2>
        <p>This requires camera access for hand tracking</p>
        <button id="start-btn">START CAMERA</button>
    </div>

    <div id="ui">
        <p>Shape: <span id="shape-name" style="color:#00ffcc">Sphere</span></p>
    </div>

    <div id="video-container">
        <video id="video-input" playsinline></video>
    </div>

    <script type="module">
        import * as THREE from 'https://cdn.skypack.dev/three@0.136.0';
        import { Hands } from 'https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js';
        import { Camera } from 'https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js';

        const PARTICLE_COUNT = 8000; // Lower for mobile stability
        let scene, camera, renderer, particles, geometry;
        let targetPositions = new Float32Array(PARTICLE_COUNT * 3);
        let currentPositions = new Float32Array(PARTICLE_COUNT * 3);
        let mouse = new THREE.Vector2();

        // --- 1. USER INTERACTION TRIGGER ---
        document.getElementById('start-btn').addEventListener('click', async () => {
            document.getElementById('overlay').style.display = 'none';
            try {
                // Request camera explicitly first
                await navigator.mediaDevices.getUserMedia({ video: true });
                initThree();
                initParticles();
                initMediaPipe();
                animate();
            } catch (err) {
                alert("Camera access denied or not supported.");
                console.error(err);
            }
        });

        // --- 2. THE THREE.JS ENGINE ---
        function initThree() {
            scene = new THREE.Scene();
            camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
            camera.position.z = 35;
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            document.body.appendChild(renderer.domElement);
        }

        function initParticles() {
            geometry = new THREE.BufferGeometry();
            // Create a simple sphere of particles
            for (let i = 0; i < PARTICLE_COUNT; i++) {
                const r = 10;
                const theta = Math.random() * Math.PI * 2;
                const phi = Math.acos((Math.random() * 2) - 1);
                const x = r * Math.sin(phi) * Math.cos(theta);
                const y = r * Math.sin(phi) * Math.sin(theta);
                const z = r * Math.cos(phi);
                currentPositions[i*3] = x; currentPositions[i*3+1] = y; currentPositions[i*3+2] = z;
                targetPositions[i*3] = x; targetPositions[i*3+1] = y; targetPositions[i*3+2] = z;
            }
            geometry.setAttribute('position', new THREE.BufferAttribute(currentPositions, 3));
            const material = new THREE.PointsMaterial({ size: 0.15, color: 0x00ffcc, transparent: true, opacity: 0.8 });
            particles = new THREE.Points(geometry, material);
            scene.add(particles);
        }

        // --- 3. MEDIAPIPE HANDS ---
        function initMediaPipe() {
            const videoElement = document.getElementById('video-input');
            const hands = new Hands({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`});
            hands.setOptions({ maxNumHands: 1, modelComplexity: 1, minDetectionConfidence: 0.5 });
            
            hands.onResults((results) => {
                if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
                    const hand = results.multiHandLandmarks[0];
                    // Map index finger to rotation
                    mouse.x = (1 - hand[8].x) * 2 - 1;
                    mouse.y = -(hand[8].y * 2 - 1);
                }
            });

            const cam = new Camera(videoElement, {
                onFrame: async () => { await hands.send({image: videoElement}); },
                width: 640, height: 480
            });
            cam.start();
        }

        function animate() {
            requestAnimationFrame(animate);
            particles.rotation.y += (mouse.x * 0.5 - particles.rotation.y) * 0.05;
            particles.rotation.x += (mouse.y * 0.5 - particles.rotation.x) * 0.05;
            renderer.render(scene, camera);
        }
    </script>
</body>
</html>
